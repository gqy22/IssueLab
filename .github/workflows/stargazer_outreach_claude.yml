name: Stargazer Outreach (Claude)

on:
  workflow_dispatch:
    inputs:
      target_username:
        description: "GitHub username to analyze and invite"
        required: true
        type: string
      language:
        description: "Invitation language"
        required: true
        default: "zh"
        type: choice
        options:
          - zh
          - en
      discussion_number:
        description: "Discussion number to post comment (optional)"
        required: false
        default: "54"
        type: string
      publish_comment:
        description: "Post invitation comment to discussion"
        required: true
        default: false
        type: boolean
      org_name:
        description: "Organization to cross-check shared membership"
        required: false
        default: "TashanGKD"
        type: string

permissions:
  contents: read
  discussions: write

jobs:
  outreach:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      TARGET_USERNAME: ${{ github.event.inputs.target_username }}
      LANGUAGE: ${{ github.event.inputs.language }}
      DISCUSSION_NUMBER: ${{ github.event.inputs.discussion_number }}
      PUBLISH_COMMENT: ${{ github.event.inputs.publish_comment }}
      ORG_NAME: ${{ github.event.inputs.org_name }}
      GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
      ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
      ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
      REPO_OWNER: ${{ github.repository_owner }}
      REPO_NAME: ${{ github.event.repository.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect GitHub signals
        run: |
          set -euo pipefail

          mkdir -p artifacts

          gh api "users/${TARGET_USERNAME}" > artifacts/user.json
          gh api "users/${TARGET_USERNAME}/repos?per_page=100" > artifacts/repos.json || echo "[]" > artifacts/repos.json
          gh api "users/${TARGET_USERNAME}/events/public?per_page=100" > artifacts/events.json || echo "[]" > artifacts/events.json
          gh api "users/${TARGET_USERNAME}/starred?per_page=100" > artifacts/starred.json || echo "[]" > artifacts/starred.json
          gh api "users/${TARGET_USERNAME}/following?per_page=100" > artifacts/following.json || echo "[]" > artifacts/following.json
          gh api "users/${TARGET_USERNAME}/orgs?per_page=100" > artifacts/user_orgs.json || echo "[]" > artifacts/user_orgs.json

          gh api "orgs/${ORG_NAME}/members?per_page=100" --paginate --jq '.[].login' > artifacts/org_members.txt || true
          if grep -qx "${TARGET_USERNAME}" artifacts/org_members.txt 2>/dev/null; then
            IN_ORG=true
          else
            IN_ORG=false
          fi
          echo "IN_ORG=${IN_ORG}" >> "$GITHUB_ENV"

          gh api "orgs/${ORG_NAME}/repos?per_page=100" --paginate --jq '.[].name' > artifacts/org_repos.txt || true
          : > artifacts/org_contrib.tsv
          while IFS= read -r repo; do
            [ -n "${repo}" ] || continue
            count=$(gh api "repos/${ORG_NAME}/${repo}/commits?author=${TARGET_USERNAME}&per_page=100" --jq 'length' 2>/dev/null || echo 0)
            if [ "${count}" -gt 0 ]; then
              latest=$(gh api "repos/${ORG_NAME}/${repo}/commits?author=${TARGET_USERNAME}&per_page=1" --jq '.[0].commit.author.date' 2>/dev/null || echo "")
              msg=$(gh api "repos/${ORG_NAME}/${repo}/commits?author=${TARGET_USERNAME}&per_page=1" --jq '.[0].commit.message' 2>/dev/null | head -n 1 | tr '\t' ' ')
              echo -e "${repo}\t${count}\t${latest}\t${msg}" >> artifacts/org_contrib.tsv
            fi
          done < artifacts/org_repos.txt

          {
            echo "# Target"
            echo "- username: ${TARGET_USERNAME}"
            echo "- language: ${LANGUAGE}"
            echo "- org_name: ${ORG_NAME}"
            echo "- in_org: ${IN_ORG}"
            echo
            echo "# Profile"
            jq -r '"- login: \(.login)\n- name: \(.name // "null")\n- company: \(.company // "null")\n- location: \(.location // "null")\n- bio: \(.bio // "null")\n- public_repos: \(.public_repos)\n- followers: \(.followers)\n- following: \(.following)\n- created_at: \(.created_at)\n- updated_at: \(.updated_at)"' artifacts/user.json
            echo
            echo "# Recent repos (top 10 by updated_at)"
            jq -r 'sort_by(.updated_at) | reverse | .[:10][] | "- \(.name) | lang=\(.language // "null") | stars=\(.stargazers_count) | updated=\(.updated_at)"' artifacts/repos.json
            echo
            echo "# Recent events (latest 20)"
            jq -r '.[:20][] | "- \(.type) | \(.repo.name) | \(.created_at)"' artifacts/events.json
            echo
            echo "# Starred repos (latest 30)"
            jq -r '.[:30][] | "- \(.full_name)"' artifacts/starred.json
            echo
            echo "# Following (first 30)"
            jq -r '.[:30][] | "- \(.login)"' artifacts/following.json
            echo
            echo "# Org contributions in ${ORG_NAME}"
            if [ -s artifacts/org_contrib.tsv ]; then
              awk -F '\t' '{printf("- %s | commits=%s | latest=%s | msg=%s\n",$1,$2,$3,$4)}' artifacts/org_contrib.tsv
            else
              echo "- no commit evidence found via author=${TARGET_USERNAME}"
            fi
          } > artifacts/context.md

      - name: Validate model/provider config
        env:
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
        run: |
          set -euo pipefail
          [ -n "${ANTHROPIC_AUTH_TOKEN:-}" ] || { echo "Missing ANTHROPIC_AUTH_TOKEN"; exit 1; }
          [ -n "${ANTHROPIC_BASE_URL:-}" ] || { echo "Missing ANTHROPIC_BASE_URL"; exit 1; }
          [ -n "${ANTHROPIC_MODEL:-}" ] || { echo "Missing ANTHROPIC_MODEL"; exit 1; }

      - name: Run Claude for analysis + invitation
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          claude_args: |
            --model ${{ env.ANTHROPIC_MODEL }}
          prompt: |
            Read:
            - .github/prompts/stargazer_outreach.md
            - artifacts/context.md
            - artifacts/user.json
            - artifacts/repos.json
            - artifacts/events.json
            - artifacts/starred.json
            - artifacts/org_contrib.tsv

            Then strictly follow the prompt spec and write:
            - artifacts/analysis.md
            - artifacts/invitation.md

            Variables:
            - TARGET_USERNAME=${{ env.TARGET_USERNAME }}
            - LANGUAGE=${{ env.LANGUAGE }}
            - IN_ORG=${{ env.IN_ORG }}
            - ORG_NAME=${{ env.ORG_NAME }}

      - name: Print outputs
        run: |
          echo "=== analysis.md ==="
          cat artifacts/analysis.md
          echo
          echo "=== invitation.md ==="
          cat artifacts/invitation.md

      - name: Post invitation to discussion
        if: ${{ github.event.inputs.publish_comment == 'true' }}
        run: |
          set -euo pipefail
          DISC_ID=$(gh api graphql -f query='query($owner:String!,$name:String!,$number:Int!){repository(owner:$owner,name:$name){discussion(number:$number){id}}}' -f owner="${REPO_OWNER}" -f name="${REPO_NAME}" -F number="${DISCUSSION_NUMBER}" --jq '.data.repository.discussion.id')
          gh api graphql \
            -f query='mutation($discussionId:ID!,$body:String!){addDiscussionComment(input:{discussionId:$discussionId,body:$body}){comment{url}}}' \
            -f discussionId="${DISC_ID}" \
            -f body="$(cat artifacts/invitation.md)"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: stargazer-outreach-${{ github.run_id }}
          path: artifacts/
          retention-days: 7
